services:
  headwind:
    image: ghcr.io/pinoykrissmith/headwind:latest
    container_name: headwind
    networks:
      - caddy_net
    volumes:
      - /elysium/headwind-data:/usr/local/tomcat/work:Z
      - /elysium/headwind-data/logs:/usr/local/tomcat/logs:Z
    environment:
      SQL_HOST: hmdm-postgres
      SQL_USER: ${SQL_USER}
      SQL_PASS: ${SQL_PASS}
      BASE_DOMAIN: ${BASE_DOMAIN}
      LOCAL_IP: ${LOCAL_IP}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      SHARED_SECRET: ${SHARED_SECRET}
      HMDM_VARIANT: ${HMDM_VARIANT}
      DOWNLOAD_CREDENTIALS: ${DOWNLOAD_CREDENTIALS}
      FORCE_RECONFIGURE: ${FORCE_RECONFIGURE}
    env_file:
      - .env
    security_opt:
      - "no-new-privileges=true"
    cap_drop:
      - "ALL"
    user: "200004:200004"
    read_only: true
    labels:
      com.centurylinklabs.watchtower.enable: "true"
      io.containers.autoupdate: "registry"
    tmpfs:
      - /usr/local/tomcat/webapps:mode=0777,noexec,nodev,nosuid
      - /usr/local/tomcat/conf/Catalina/localhost:mode=0777,noexec,nodev,nosuid
      - /usr/local/tomcat/temp:mode=0777,noexec,nodev,nosuid

  hmdm-postgres:
    image: ghcr.io/polarix-containers/postgres:13
    container_name: hmdm-postgres
    restart: unless-stopped
    volumes:
      - /elysium/headwind-postgres:/var/lib/postgresql/data:Z
    environment:
      - POSTGRES_USER=${SQL_USER}
      - POSTGRES_PASSWORD=${SQL_PASS}
      - POSTGRES_DB=${SQL_BASE}
      - LD_PRELOAD=""
    env_file:
      - .env
    user: "200012:200012"
    read_only: true
    labels:
      com.centurylinklabs.watchtower.enable: "true"
      io.containers.autoupdate: "registry"
    tmpfs:
      - /var/run/postgres:noexec,nosuid,nodev
    security_opt:
      - "no-new-privileges=true"
    cap_drop:
      - ALL
    networks:
      - caddy_net

networks:
  caddy_net:
    name: caddy_net
    external: true